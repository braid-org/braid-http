<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .iframe-container-wrapper {
            width: 100%;
            background-color: #f9f9f9;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        .iframe-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 0 10px;
        }
        .iframe-group {
            display: flex;
            width: 49.5%;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .group-3008 {
            background-color: #e3f2fd;
        }
        .group-3009 {
            background-color: #f3e5f5;
        }
        .iframe-container iframe {
            width: 48.5%;
            height: 300px;
            border: 1px solid #ddd;
        }
        .content-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th:first-child, td:first-child {
            width: 50%;
        }
        th:not(:first-child), td:not(:first-child) {
            width: 25%;
            overflow: scroll;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
        }
        .queued {
            background-color: #e0e0e0;
        }
        .running {
            background-color: #fffde7;
        }
        .passed {
            background-color: #e8f5e9;
        }
        .failed {
            background-color: #ffebee;
        }
        .other {
            background-color: #ebeeff;
        }
        .section-header {
            background-color: #fefefe;
            font-weight: bold;
        }
        #summaryContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
        }
        .summaryBox {
            width: 25px;
            height: 25px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<script src="/braid-http-client.js"></script>
<script src="/tests.js"></script>

<div class="iframe-container-wrapper">
    <div class="iframe-container">
        <div class="iframe-group group-3008">
            <iframe src="https://localhost:3008/"></iframe>
            <iframe src="https://localhost:3008/"></iframe>
        </div>
        <div class="iframe-group group-3009">
            <iframe src="https://localhost:3009/"></iframe>
            <iframe src="https://localhost:3009/"></iframe>
        </div>
    </div>
</div>

<div class="content-container">
    <div id="summaryContainer"></div>
    <table id="testTable">
        <tr>
            <th>Name</th>
            <th>Your Server's Responses</th>
            <th>Known Server Responses</th>
        </tr>
    </table>
</div>
<script type="module">

var og_fetch = fetch
fetch = braid_fetch
let test_update = {
    version: ['test'],
    parents: ['oldie'],
    body: JSON.stringify({this: 'stuff'}),
    status: "200"
}
let delay = 0
var port = 9000

function createTestRow(testName, expected) {
    const row = document.createElement("tr")
    row.innerHTML = `
        <td>${testName}</td>
        <td class="result">Queued...</td>
    `
    row.className = "queued"
    testTable.appendChild(row)

    const expectedCell = document.createElement("td")
    expectedCell.textContent = expected
    row.appendChild(expectedCell)

    return row
}

function updateTestResult(row, status, got) {
    row.className = status
    
    const resultCell = row.querySelector(".result")
    resultCell.textContent = got
}

function addSectionHeader(headerText) {
    const row = document.createElement("tr")
    let cell = document.createElement("td")
    cell.textContent = headerText
    cell.className = "section-header"
    cell.setAttribute("colspan", "3")
    row.appendChild(cell)
    testTable.appendChild(row)
}

let summaryContainer = document.getElementById('summaryContainer');

function createSummaryBox(isQueued = false) {
    const box = document.createElement('div');
    box.className = `summaryBox ${isQueued ? 'queued' : 'running'}`;
    summaryContainer.appendChild(box);
    return box;
}

function updateSummaryBox(box, passed) {
    box.className = `summaryBox ${passed ? 'passed' : passed === false ? 'failed' : 'other'}`;
}

function setSummaryBoxRunning(box) {
    box.className = 'summaryBox running';
}

var wait_for_me = Promise.resolve()
var wait_list = []

function waitForTests(cb) {
    wait_for_me = Promise.all([wait_for_me, ...wait_list]).then(() => cb())
    wait_list = []    
}

// Parse URL for filter parameter
const urlParams = new URLSearchParams(window.location.search)
const filterArg = urlParams.get('filter') || urlParams.get('grep')

function runTest(testName, testFunction, expectedResult) {
    // Skip tests that don't match filter
    if (filterArg && !testName.toLowerCase().includes(filterArg.toLowerCase())) {
        return
    }

    const summaryBox = createSummaryBox(true);
    const row = createTestRow(testName, expectedResult)
    
    wait_list.push(wait_for_me.then(async () => {

        // Now the test is actually running, update box from grey to yellow
        setSummaryBoxRunning(summaryBox);
        updateTestResult(row, 'running', 'Running..')

        delay += 70

        await new Promise(done => setTimeout(done, delay))

        try {
            let got = await testFunction()
            if (got === expectedResult) {
                updateTestResult(row, 'passed', got)
                updateSummaryBox(summaryBox, true)
            } else if (got === 'old node version') {
                updateTestResult(row, 'other', got)
                updateSummaryBox(summaryBox, undefined)
            } else {
                updateTestResult(row, 'failed', got)
                updateSummaryBox(summaryBox, false)
            }
        } catch (error) {
            updateTestResult(row, 'failed', error.message || error)
            updateSummaryBox(summaryBox, false)
        }
    }))
}

// Load and run all tests from the shared tests.js file
defineTests(runTest, { fetch, og_fetch, port, addSectionHeader, waitForTests, test_update, multiplex_fetch, braid_fetch })

</script>
